<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "mybatis-3-mapper.dtd">
<mapper namespace="admin">

  <!-- ************************************************************
       0)
       - 게시글 공통 메타는 TBL_POST에서 관리(POST_NUMBER, POST_TYPE, TITLE 등)
       - 상세 본문은 타입별 콘텐츠 테이블에서 관리:
         * 자유글:   TBL_FREE        (FREE_CONTENT)
         * 홍보글:   TBL_PROMOTION   (PROMO_CONTENT)
         * 레시피:   TBL_RECIPE      (RECIPE_CONTENT)
         * 공지:     TBL_NOTICE      (NOTICE_CONTENT)
       - 관리자 작성 공지는 POST + NOTICE 2단 삽입
       - 시퀀스: SEQ_POST (필요 시 이름 변경)
       ************************************************************ -->

<!--  -->
  <!-- ************************************************************
       1) 목록 조회 (공통)
       - 특정 POST_TYPE의 게시글 목록을 페이징으로 조회
       - 검색(옵션): searchType = 'title' | 'memberId', keyword 사용
       - 반환: PostListDTO
       ************************************************************ -->
  <select id="selectPostListByType" parameterType="map"
          resultType="PostListDTO">
    <![CDATA[
    SELECT * FROM (
      SELECT ROWNUM AS rnum, sub.*
        FROM (
          SELECT
            p.post_number       AS postNumber,
            p.post_type         AS postType,
            p.post_title        AS postTitle,
            p.post_created_date AS postCreatedDate,
            p.post_updated_date AS postUpdatedDate,
            p.post_view_count   AS postViewCount,
            p.post_like_count   AS postLikeCount,
            m.member_number     AS memberNumber,
            m.member_id         AS memberId
          FROM TBL_POST p
          JOIN TBL_MEMBER m
            ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
          WHERE p.POST_TYPE = #{postType}
            AND NVL(p.DELETE_STATE, 'N') = 'N'
          /* ===== [옵션] 검색 필터 ===== */
          /* searchType = 'title' | 'memberId', keyword 존재 시 필터 */
          /* 동적 where 절 */
          /* title 검색 */
          /* memberId 검색 */
          /* ======================== */
          ORDER BY p.POST_CREATED_DATE DESC
        ) sub
    )
    WHERE rnum BETWEEN #{startRow} AND #{endRow}
    ]]>
    <if test="keyword != null and keyword != ''">
      <if test="searchType == 'title'">
        <![CDATA[ AND LOWER(p.POST_TITLE) LIKE LOWER('%' || #{keyword} || '%') ]]>
      </if>
      <if test="searchType == 'memberId'">
        <![CDATA[ AND LOWER(m.MEMBER_ID) LIKE LOWER('%' || #{keyword} || '%') ]]>
      </if>
    </if>
  </select>

  <!-- (선택) 전체 건수: 페이징용 카운트 -->
  <select id="countPostsByType" parameterType="map" resultType="int">
    <![CDATA[
      SELECT COUNT(*)
      FROM TBL_POST p
      JOIN TBL_MEMBER m ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
      WHERE p.POST_TYPE = #{postType}
        AND NVL(p.DELETE_STATE, 'N') = 'N'
    ]]>
    <if test="keyword != null and keyword != ''">
      <if test="searchType == 'title'">
        <![CDATA[ AND LOWER(p.POST_TITLE) LIKE LOWER('%' || #{keyword} || '%') ]]>
      </if>
      <if test="searchType == 'memberId'">
        <![CDATA[ AND LOWER(m.MEMBER_ID) LIKE LOWER('%' || #{keyword} || '%') ]]>
      </if>
    </if>
  </select>


  <!-- ************************************************************
       2) 상세 조회 (타입별)
       - 반환: com.bapseguen.app.dto.view.PostDetailDTO
       - 자유/홍보/레시피/공지 각각 본문 컬럼 alias를 DTO 필드명에 맞춤
       ************************************************************ -->

  <!-- 자유 상세 -->
  <select id="selectFreeDetail" parameterType="int"
          resultType="com.bapseguen.app.dto.view.PostDetailDTO">
    <![CDATA[
      SELECT
        p.post_number       AS postNumber,
        p.post_type         AS postType,
        p.post_title        AS postTitle,
        p.post_created_date AS postCreatedDate,
        p.post_updated_date AS postUpdatedDate,
        p.post_view_count   AS postViewCount,
        p.post_like_count   AS postLikeCount,
        m.member_number     AS memberNumber,
        m.member_id         AS memberId,
        f.free_content      AS freeContent
      FROM TBL_POST p
      JOIN TBL_MEMBER m  ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
      JOIN TBL_FREE   f  ON f.POST_NUMBER  = p.POST_NUMBER
      WHERE p.POST_NUMBER = #{postNumber}
    ]]>
  </select>

  <!-- 홍보 상세 -->
  <select id="selectPromotionDetail" parameterType="int"
          resultType="com.bapseguen.app.dto.view.PostDetailDTO">
    <![CDATA[
      SELECT
        p.post_number       AS postNumber,
        p.post_type         AS postType,
        p.post_title        AS postTitle,
        p.post_created_date AS postCreatedDate,
        p.post_updated_date AS postUpdatedDate,
        p.post_view_count   AS postViewCount,
        p.post_like_count   AS postLikeCount,
        m.member_number     AS memberNumber,
        m.member_id         AS memberId,
        pr.promo_content    AS promoContent
      FROM TBL_POST p
      JOIN TBL_MEMBER m   ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
      JOIN TBL_PROMOTION pr ON pr.POST_NUMBER = p.POST_NUMBER
      WHERE p.POST_NUMBER = #{postNumber}
    ]]>
  </select>

  <!-- 레시피 상세 -->
  <select id="selectRecipeDetail" parameterType="int"
          resultType="com.bapseguen.app.dto.view.PostDetailDTO">
    <![CDATA[
      SELECT
        p.post_number       AS postNumber,
        p.post_type         AS postType,
        p.post_title        AS postTitle,
        p.post_created_date AS postCreatedDate,
        p.post_updated_date AS postUpdatedDate,
        p.post_view_count   AS postViewCount,
        p.post_like_count   AS postLikeCount,
        m.member_number     AS memberNumber,
        m.member_id         AS memberId,
        r.recipe_content    AS recipeContent
      FROM TBL_POST p
      JOIN TBL_MEMBER m ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
      JOIN TBL_RECIPE  r ON r.POST_NUMBER  = p.POST_NUMBER
      WHERE p.POST_NUMBER = #{postNumber}
    ]]>
  </select>

  <!-- 공지 상세 -->
  <select id="selectNoticeDetail" parameterType="int"
          resultType="com.bapseguen.app.dto.view.PostDetailDTO">
    <![CDATA[
      SELECT
        p.post_number       AS postNumber,
        p.post_type         AS postType,
        p.post_title        AS postTitle,
        p.post_created_date AS postCreatedDate,
        p.post_updated_date AS postUpdatedDate,
        p.post_view_count   AS postViewCount,
        p.post_like_count   AS postLikeCount,
        m.member_number     AS memberNumber,
        m.member_id         AS memberId,
        n.notice_content    AS noticeContent
      FROM TBL_POST p
      JOIN TBL_MEMBER m ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
      JOIN TBL_NOTICE n ON n.POST_NUMBER   = p.POST_NUMBER
      WHERE p.POST_NUMBER = #{postNumber}
    ]]>
  </select>


  <!-- ************************************************************
       3) 생성 (관리자 공지)
       - 1단계: POST 행 생성(selectKey로 POST_NUMBER 채움)
       - 2단계: NOTICE 본문 삽입
       - 파라미터 DTO:
           * admin.insertPost          : com.bapseguen.app.dto.PostDTO
           * admin.insertNoticeContent : com.bapseguen.app.dto.NoticeDTO
       ************************************************************ -->

  <insert id="insertPost" parameterType="com.bapseguen.app.dto.PostDTO" useGeneratedKeys="false">
    <!-- 시퀀스명 변경 시 여기만 수정(예: SEQ_POST) -->
    <selectKey resultType="int" keyProperty="postNumber" order="BEFORE">
      SELECT SEQ_POST.NEXTVAL FROM DUAL
    </selectKey>
    <![CDATA[
      INSERT INTO TBL_POST
        (POST_NUMBER, MEMBER_NUMBER, POST_TYPE, POST_TITLE,
         POST_CREATED_DATE, POST_VIEW_COUNT, POST_LIKE_COUNT, DELETE_STATE)
      VALUES
        (#{postNumber}, #{memberNumber}, #{postType}, #{postTitle},
         SYSDATE, 0, 0, 'N')
    ]]>
  </insert>

  <insert id="insertNoticeContent" parameterType="com.bapseguen.app.dto.NoticeDTO">
    <![CDATA[
      INSERT INTO TBL_NOTICE (POST_NUMBER, NOTICE_CONTENT)
      VALUES (#{postNumber}, #{noticeContent})
    ]]>
  </insert>


  <!-- ************************************************************
       4) 수정 (관리자 공지)
       - 제목은 POST에서, 본문은 NOTICE에서 수정
       ************************************************************ -->

  <update id="updatePostTitle" parameterType="map">
    <![CDATA[
      UPDATE TBL_POST
         SET POST_TITLE = #{postTitle},
             POST_UPDATED_DATE = SYSDATE
       WHERE POST_NUMBER = #{postNumber}
    ]]>
  </update>

  <update id="updateNotice" parameterType="map">
    <![CDATA[
      UPDATE TBL_NOTICE
         SET NOTICE_CONTENT = #{noticeContent}
       WHERE POST_NUMBER = #{postNumber}
    ]]>
  </update>


  <!-- ************************************************************
       5) 삭제 (타입별 본문 → POST)
       - 실제 운영에서는 DELETE_STATE='Y' 소프트 삭제 권장
       ************************************************************ -->

  <delete id="deleteFree" parameterType="int">
    DELETE FROM TBL_FREE WHERE POST_NUMBER = #{postNumber}
  </delete>

  <delete id="deletePromotion" parameterType="int">
    DELETE FROM TBL_PROMOTION WHERE POST_NUMBER = #{postNumber}
  </delete>

  <delete id="deleteRecipe" parameterType="int">
    DELETE FROM TBL_RECIPE WHERE POST_NUMBER = #{postNumber}
  </delete>

  <delete id="deleteNotice" parameterType="int">
    DELETE FROM TBL_NOTICE WHERE POST_NUMBER = #{postNumber}
  </delete>

  <delete id="deletePost" parameterType="int">
    DELETE FROM TBL_POST WHERE POST_NUMBER = #{postNumber}
  </delete>

</mapper>
