<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD MyBatis 3.0 Mapper DTD//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="admin">

	<!-- ===================== 관리자 로그인 ===================== -->
	<select id="loginAdmin" parameterType="AdminDTO"
		resultType="AdminDTO">
		SELECT
		ADMIN_NUMBER AS adminNumber,
		ADMIN_ID AS adminId,
		ADMIN_PASSWORD AS adminPassword,
		ADMIN_TREE_GRADE AS adminTreeGrade
		FROM TBL_ADMIN
		WHERE ADMIN_ID = #{adminId}
		AND ADMIN_PASSWORD = #{adminPassword}
	</select>


	<!-- ===================== 공지/이벤트(Notice) ===================== -->
	<insert id="insertNoticePost"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		<selectKey resultType="int" keyProperty="postNumber"
			order="BEFORE">
			SELECT SEQ_POST_NUMBER.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TBL_POST
		(POST_NUMBER, MEMBER_NUMBER, ADMIN_NUMBER, POST_TITLE,
		POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
		POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE)
		VALUES
		(#{postNumber}, NULL, #{adminNumber}, #{postTitle},
		0, 0, 0, 'N', SYSDATE, 'NOTICE')
	</insert>

	<insert id="insertNotice"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		INSERT INTO TBL_NOTICE
		(POST_NUMBER, NOTICE_CONTENT)
		VALUES
		(#{postNumber}, #{noticeContent})
	</insert>

	<!-- 목록 (페이징 + 검색 포함) -->
	<select id="selectNoticeList" parameterType="map"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT * FROM (
		SELECT ROWNUM AS rowNumber, A.* FROM (
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE, 'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE, 'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		n.NOTICE_CONTENT AS noticeContent,
		a.ADMIN_NUMBER AS adminNumber,
		a.ADMIN_ID AS adminId,
		a.ADMIN_TREE_GRADE AS adminTreeGrade
		FROM TBL_POST p
		JOIN TBL_NOTICE n ON n.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_ADMIN a ON a.ADMIN_NUMBER = p.ADMIN_NUMBER
		WHERE p.POST_TYPE = 'NOTICE'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
		ORDER BY p.POST_NUMBER DESC
		) A
		WHERE ROWNUM &lt;= #{endRow}
		)
		WHERE rowNumber &gt;= #{startRow}
	</select>

	<select id="countNotices" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM TBL_POST p
		JOIN TBL_NOTICE n ON n.POST_NUMBER = p.POST_NUMBER
		WHERE p.POST_TYPE = 'NOTICE'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
	</select>

	<select id="selectNoticeDetail" parameterType="int"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE, 'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE, 'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		n.NOTICE_CONTENT AS noticeContent,
		a.ADMIN_NUMBER AS adminNumber,
		a.ADMIN_ID AS adminId,
		a.ADMIN_TREE_GRADE AS adminTreeGrade
		FROM TBL_POST p
		JOIN TBL_NOTICE n ON n.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_ADMIN a ON a.ADMIN_NUMBER = p.ADMIN_NUMBER
		WHERE p.POST_NUMBER = #{postNumber}
	</select>

	<update id="updateNoticeTitle"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		UPDATE TBL_POST
		SET POST_TITLE = #{postTitle},
		POST_UPDATED_DATE = SYSDATE
		WHERE POST_NUMBER = #{postNumber}
	</update>

	<update id="updateNoticeContent"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		UPDATE TBL_NOTICE
		SET NOTICE_CONTENT = #{noticeContent}
		WHERE POST_NUMBER = #{postNumber}
	</update>

	<delete id="deleteNotice" parameterType="int">
		DELETE FROM TBL_POST WHERE POST_NUMBER = #{postNumber}
	</delete>


	<!-- ===================== FAQ ===================== -->
	<insert id="insertFaqPost"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		<selectKey resultType="int" keyProperty="postNumber"
			order="BEFORE">
			SELECT SEQ_POST_NUMBER.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO TBL_POST
		(POST_NUMBER, MEMBER_NUMBER, ADMIN_NUMBER, POST_TITLE,
		POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
		POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE)
		VALUES
		(#{postNumber}, NULL, #{adminNumber}, #{postTitle},
		0, 0, 0, 'N', SYSDATE, 'FAQ')
	</insert>

	<insert id="insertFaq"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		INSERT INTO TBL_FAQ
		(POST_NUMBER, FAQ_CONTENT)
		VALUES
		(#{postNumber}, #{faqContent})
	</insert>

	<!-- 목록 (페이징 + 검색 포함) -->
	<select id="selectFaqList" parameterType="map"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT * FROM (
		SELECT ROWNUM AS rowNumber, A.* FROM (
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE, 'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE, 'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		f.FAQ_CONTENT AS faqContent,
		a.ADMIN_NUMBER AS adminNumber,
		a.ADMIN_ID AS adminId,
		a.ADMIN_TREE_GRADE AS adminTreeGrade
		FROM TBL_POST p
		JOIN TBL_FAQ f ON f.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_ADMIN a ON a.ADMIN_NUMBER = p.ADMIN_NUMBER
		WHERE p.POST_TYPE = 'FAQ'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
		ORDER BY p.POST_NUMBER DESC
		) A
		WHERE ROWNUM &lt;= #{endRow}
		)
		WHERE rowNumber &gt;= #{startRow}
	</select>

	<select id="countFaqs" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM TBL_POST p
		JOIN TBL_FAQ f ON f.POST_NUMBER = p.POST_NUMBER
		WHERE p.POST_TYPE = 'FAQ'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
	</select>

	<select id="selectFaqDetail" parameterType="int"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE, 'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE, 'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		f.FAQ_CONTENT AS faqContent,
		a.ADMIN_NUMBER AS adminNumber,
		a.ADMIN_ID AS adminId,
		a.ADMIN_TREE_GRADE AS adminTreeGrade
		FROM TBL_POST p
		JOIN TBL_FAQ f ON f.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_ADMIN a ON a.ADMIN_NUMBER = p.ADMIN_NUMBER
		WHERE p.POST_NUMBER = #{postNumber}
	</select>

	<update id="updateFaqTitle"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		UPDATE TBL_POST
		SET POST_TITLE = #{postTitle},
		POST_UPDATED_DATE = SYSDATE
		WHERE POST_NUMBER = #{postNumber}
	</update>

	<update id="updateFaqContent"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		UPDATE TBL_FAQ
		SET FAQ_CONTENT = #{faqContent}
		WHERE POST_NUMBER = #{postNumber}
	</update>

	<delete id="deleteFaq" parameterType="int">
		DELETE FROM TBL_POST WHERE POST_NUMBER = #{postNumber}
	</delete>


	<!-- ===================== 관리자 이미지 ===================== -->
	<insert id="insertAdminImage" parameterType="AdminImageDTO">
		INSERT INTO TBL_ADMIN_IMAGE
		(ADMIN_IMAGE_NUMBER, ADMIN_IMAGE_SYSTEM_NAME,
		ADMIN_IMAGE_ORIGINAL_NAME, ADMIN_NUMBER, POST_NUMBER)
		VALUES
		(SEQ_ADMIN_IMAGE_NUMBER.NEXTVAL,
		#{adminImageSystemName}, #{adminImageOriginalName},
		#{adminNumber}, #{postNumber})
	</insert>

	<select id="selectAdminImagesByPost" parameterType="int"
		resultType="AdminImageDTO">
		SELECT
		ADMIN_IMAGE_NUMBER AS adminImageNumber,
		ADMIN_IMAGE_SYSTEM_NAME AS adminImageSystemName,
		ADMIN_IMAGE_ORIGINAL_NAME AS adminImageOriginalName,
		ADMIN_NUMBER AS adminNumber,
		POST_NUMBER AS postNumber
		FROM TBL_ADMIN_IMAGE
		WHERE POST_NUMBER = #{postNumber}
	</select>

	<delete id="deleteAdminImagesByPost" parameterType="int">
		DELETE FROM TBL_ADMIN_IMAGE
		WHERE POST_NUMBER = #{postNumber}
	</delete>


	<!-- ===================== 대시보드 통계 ===================== -->
	<select id="countReports" resultType="int">
		SELECT COUNT(*) FROM TBL_POST_REPORT
	</select>

	<select id="countInquiries" resultType="int">
		SELECT COUNT(*) FROM TBL_INQUIRY
	</select>

	<select id="countUnansweredInquiries" resultType="int">
		SELECT COUNT(*) FROM TBL_INQUIRY WHERE INQUIRY_STATUS = 'YET'
	</select>

	<!-- ===================== 문의(Inquiry) ===================== -->
	<select id="selectInquiryList" parameterType="map"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT * FROM (
		SELECT ROWNUM AS rowNumber, A.* FROM (
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE,'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE,'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		i.INQUIRY_CONTENT AS inquiryContent,
		i.INQUIRY_STATUS AS inquiryStatus,
		m.MEMBER_NUMBER AS memberNumber,
		m.MEMBER_ID AS memberId,
		CASE m.MEMBER_TYPE
		WHEN 'GENERAL' THEN g.GENERAL_NAME
		WHEN 'SELLER' THEN s.SELLER_NAME
		END AS memberName
		FROM TBL_POST p
		JOIN TBL_INQUIRY i ON i.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_MEMBER m ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
		LEFT JOIN TBL_GENERAL_MEMBER g ON g.MEMBER_NUMBER = m.MEMBER_NUMBER
		LEFT JOIN TBL_SELLER_MEMBER s ON s.MEMBER_NUMBER = m.MEMBER_NUMBER
		WHERE p.POST_TYPE = 'INQUIRY'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
		ORDER BY p.POST_NUMBER DESC
		) A
		WHERE ROWNUM &lt;= #{endRow}
		)
		WHERE rowNumber &gt;= #{startRow}
	</select>

	<select id="countInquiries" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM TBL_POST p
		JOIN TBL_INQUIRY i ON i.POST_NUMBER = p.POST_NUMBER
		WHERE p.POST_TYPE = 'INQUIRY'
		<if test="searchWord != null and searchWord != ''">
			AND p.POST_TITLE LIKE '%' || #{searchWord} || '%'
		</if>
	</select>

	<select id="selectInquiryDetail" parameterType="int"
		resultType="com.bapseguen.app.dto.view.AdminPostDTO">
		SELECT
		p.POST_NUMBER AS postNumber,
		p.POST_TITLE AS postTitle,
		TO_CHAR(p.POST_CREATED_DATE,'YYYY-MM-DD') AS postCreatedDate,
		TO_CHAR(p.POST_UPDATED_DATE,'YYYY-MM-DD') AS postUpdatedDate,
		p.POST_TYPE AS postType,
		i.INQUIRY_CONTENT AS inquiryContent,
		i.INQUIRY_STATUS AS inquiryStatus,
		m.MEMBER_NUMBER AS memberNumber,
		m.MEMBER_ID AS memberId,
		CASE m.MEMBER_TYPE
		WHEN 'GENERAL' THEN g.GENERAL_NAME
		WHEN 'SELLER' THEN s.SELLER_NAME
		END AS memberName
		FROM TBL_POST p
		JOIN TBL_INQUIRY i ON i.POST_NUMBER = p.POST_NUMBER
		JOIN TBL_MEMBER m ON m.MEMBER_NUMBER = p.MEMBER_NUMBER
		LEFT JOIN TBL_GENERAL_MEMBER g ON g.MEMBER_NUMBER = m.MEMBER_NUMBER
		LEFT JOIN TBL_SELLER_MEMBER s ON s.MEMBER_NUMBER = m.MEMBER_NUMBER
		WHERE p.POST_NUMBER = #{postNumber}
	</select>

	<update id="updateInquiryStatus"
		parameterType="com.bapseguen.app.dto.view.AdminPostDTO">
		UPDATE TBL_INQUIRY
		SET INQUIRY_STATUS = #{inquiryStatus}
		WHERE POST_NUMBER = #{postNumber}
	</update>


</mapper>
