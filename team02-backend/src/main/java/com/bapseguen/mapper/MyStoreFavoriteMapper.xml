<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="myStoreFavorite">

	<!-- 찜 목록 조회 (리뷰 평균/리뷰 수만 조회) -->
	<select id="MyFavSelectAll"
		resultType="com.bapseguen.app.dto.StoreFavoriteDTO"
		parameterType="map">
        <![CDATA[
        SELECT *
        FROM (
            SELECT
                F.FAVORITE_NUMBER      AS favoriteNumber,
                F.MEMBER_NUMBER        AS memberNumber,
                F.BUSINESS_NUMBER      AS businessNumber,
                S.STORE_NAME           AS businessName,
                S.STORE_OPEN_TIME      AS openTime,
                S.STORE_CLOSE_TIME     AS closeTime,
                NVL(ROUND(AVG(R.REVIEW_RATING),1),0) AS avgRating,
                NVL(COUNT(R.REVIEW_NUMBER),0)        AS reviewCount,
                ROW_NUMBER() OVER (ORDER BY F.FAVORITE_NUMBER DESC) AS RNUM
            FROM TBL_STORE_FAVORITE F
            JOIN TBL_STORE S ON F.BUSINESS_NUMBER = S.BUSINESS_NUMBER
            LEFT JOIN TBL_REVIEW R ON S.BUSINESS_NUMBER = R.BUSINESS_NUMBER
            WHERE F.MEMBER_NUMBER = #{memberNumber}
            GROUP BY
                F.FAVORITE_NUMBER,
                F.MEMBER_NUMBER,
                F.BUSINESS_NUMBER,
                S.STORE_NAME,
                S.STORE_OPEN_TIME,
                S.STORE_CLOSE_TIME
        ) SUBQUERY
        WHERE SUBQUERY.RNUM BETWEEN #{startRow} AND #{endRow}
        ]]>
	</select>

	<!-- 가게별 판매중 메뉴 개수 -->
	<select id="getMenuCount" parameterType="string"
		resultType="int">
		SELECT COUNT(*)
		FROM TBL_ITEM
		WHERE BUSINESS_NUMBER =
		#{businessNumber}
		AND ITEM_SELL_STATE = 'Y'
	</select>

	<!-- 가게별 대표 이미지 (가게당 1장만 존재) -->
	<select id="getStoreImage" parameterType="string"
		resultType="com.bapseguen.app.dto.StoreFavoriteDTO">
		SELECT
		STORE_IMAGE_SYSTEM_NAME AS storeImageSystemName,
		STORE_IMAGE_ORIGINAL_NAME AS storeImageOriginalName
		FROM TBL_STORE_IMAGE
		WHERE BUSINESS_NUMBER = #{businessNumber}
	</select>

	<!-- 찜 여부 확인 -->
	<select id="exists" parameterType="map" resultType="int">
		SELECT
		COUNT(*)
		FROM TBL_STORE_FAVORITE
		WHERE MEMBER_NUMBER = #{memberNumber}
		AND BUSINESS_NUMBER = #{businessNumber}
	</select>

	<!-- 회원별 찜 개수 -->
	<select id="countByMember" parameterType="int" resultType="int">
		SELECT COUNT(*)
		FROM TBL_STORE_FAVORITE
		WHERE MEMBER_NUMBER =
		#{memberNumber}
	</select>

	<!-- 찜 추가 -->
	<insert id="MyFavInsert"
		parameterType="com.bapseguen.app.dto.StoreFavoriteDTO">
		INSERT INTO TBL_STORE_FAVORITE (
		FAVORITE_NUMBER,
		MEMBER_NUMBER, BUSINESS_NUMBER
		) VALUES (
		SEQ_STORE_FAVORITE_NUMBER.NEXTVAL,
		#{memberNumber},
		#{businessNumber}
		)
	</insert>

	<!-- 찜 해제 -->
	<delete id="MyFavDelete"
		parameterType="com.bapseguen.app.dto.StoreFavoriteDTO">
		DELETE FROM TBL_STORE_FAVORITE
		WHERE MEMBER_NUMBER =
		#{memberNumber}
		AND BUSINESS_NUMBER = #{businessNumber}
	</delete>

</mapper>
