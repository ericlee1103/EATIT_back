<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="review">

    <!-- 특정 가게 리뷰 목록 -->
    <select id="selectReviewsByBusiness" parameterType="string" resultType="com.bapseguen.app.dto.view.ReviewWithUserDTO">
        SELECT
            r.REVIEW_NUMBER     AS reviewNumber,
            r.ORDERS_NUMBER     AS ordersNumber,
            r.BUSINESS_NUMBER   AS businessNumber,
            r.MEMBER_NUMBER     AS memberNumber,
            r.REVIEW_RATING     AS reviewRating,
            r.REVIEW_CONTENT    AS reviewContent,
            TO_CHAR(r.REVIEW_CREATE_DATE, 'YYYY-MM-DD') AS reviewCreateDate,
            m.MEMBER_ID         AS memberId,
            (SELECT i.ITEM_NAME
             FROM TBL_ORDER_ITEM oi
             JOIN TBL_ITEM i ON oi.ITEM_NUMBER = i.ITEM_NUMBER
             WHERE oi.ORDERS_NUMBER = r.ORDERS_NUMBER
             FETCH FIRST 1 ROWS ONLY) AS itemName
        FROM TBL_REVIEW r
        LEFT JOIN TBL_MEMBER m ON r.MEMBER_NUMBER = m.MEMBER_NUMBER
        WHERE r.BUSINESS_NUMBER = #{businessNumber}
        ORDER BY r.REVIEW_CREATE_DATE DESC
    </select>

</mapper>
