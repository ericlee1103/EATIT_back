<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="inquiry">
	<!-- 고객센터 문의 목록 조회 -->
	<select id="inquirySelectAll" resultType="InquiryDetailDTO">
	<![CDATA[
		SELECT * FROM(
		SELECT
		ROWNUM AS RNUM,SUBQUERY.*
		FROM(
		SELECT
		M.MEMBER_NUMBER,M.MEMBER_ID,P.POST_NUMBER,P.POST_Title,P.POST_CREATED_DATE,P.POST_VIEW_COUNT,I.INQUIRY_STATUS
		FROM TBL_MEMBER M JOIN TBL_POST P ON M.MEMBER_NUMBER = P.MEMBER_NUMBER
		JOIN TBL_INQUIRY I ON P.POST_NUMBER = I.POST_NUMBER
		ORDER BY
		P.POST_CREATED_DATE DESC
		)SUBQUERY
		)WHERE RNUM BETWEEN #{startRow} AND
		#{endRow}
		]]>
	</select>

	<select id="inquiryListCount" resultType="int">
		SELECT COUNT(*)
		FROM
		TBL_INQUIRY
	</select>

	<!--조회수 쿼리 -->
	<update id="inquiryUpdateReadCount" parameterType="int">
		UPDATE
		TBL_POST
		SET POST_VIEW_COUNT = POST_VIEW_COUNT + 1
		WHERE POST_NUMBER =
		#{postNumber}
	</update>

	<!-- 문의 작성 -->
	<insert id="insertInquiryPost" parameterType="map"
		useGeneratedKeys="true" keyProperty="postNumber">
		INSERT INTO TBL_POST (
		POST_NUMBER, MEMBER_NUMBER, POST_TITLE,
		POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
		POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE
		)
		VALUES (
		SEQ_POST_NUMBER.NEXTVAL,
		#{memberNumber},
		#{postTitle},
		0,0,0,
		'N',
		SYSDATE, 'INQUIRY'
		)
		<selectKey keyProperty="postNumber" resultType="int"
			order="AFTER">
			SELECT SEQ_POST_NUMBER.CURRVAL FROM DUAL
		</selectKey>
	</insert>

	<insert id="insertInquiryContent" parameterType="map">
		INSERT INTO
		TBL_INQUIRY (POST_NUMBER, INQUIRY_CONTENT, INQUIRY_STATUS)
		VALUES
		(#{postNumber}, #{inquiryContent}, #{inquiryStatus})
	</insert>

	<!-- 고객센터 문의글 상세(1건조회) -->
	<select id="inquirySelect" parameterType="int"
		resultType="InquiryDetailDTO">
		SELECT
		M.MEMBER_NUMBER,
		M.MEMBER_ID,
		P.POST_NUMBER,
		P.POST_TITLE,
		P.POST_CREATED_DATE,
		P.POST_VIEW_COUNT,
		I.INQUIRY_STATUS,
		I.INQUIRY_CONTENT
		FROM
		TBL_MEMBER M
		JOIN
		TBL_POST P ON M.MEMBER_NUMBER =
		P.MEMBER_NUMBER
		JOIN
		TBL_INQUIRY I ON P.POST_NUMBER = I.POST_NUMBER
		WHERE
		P.POST_NUMBER = #{postNumber}
	</select>

	<!-- 문의 삭제 쿼리 / 글 내용 -->
	<delete id="inquiryDelete" parameterType="int">
		DELETE FROM TBL_INQUIRY
		WHERE POST_NUMBER = #{postNumber}
	</delete>
	<!-- 문의 게시글 삭제 쿼리 / 게시글 내용제외 -->
	<delete id="postDelete" parameterType="int">
		DELETE FROM TBL_POST
		WHERE
		POST_NUMBER = #{postNumber}
	</delete>
	<!-- 문의 게시글 삭제 쿼리 / 이미지 -->
	<delete id="inquiryImageDelete" parameterType="int">
		DELETE FROM
		TBL_POST_IMAGE
		WHERE POST_NUMBER = #{postNumber}
	</delete>

	<!-- 게시글 삭제시 포스트타입 조회 -->
	<select id="getPostType" parameterType="int" resultType="string">
		SELECT
		POST_TYPE
		FROM TBL_POST
		WHERE POST_NUMBER = #{postNumber}
	</select>

	<!-- 게시글 검색 -->
	<select id="searchInquiries" parameterType="string"
		resultType="InquiryDetailDTO">
		<![CDATA[
    		SELECT *
    		FROM (
        	SELECT ROWNUM AS RNUM, SUBQUERY.*
        	FROM (
            SELECT 
            M.MEMBER_NUMBER,
            M.MEMBER_ID,
            P.POST_NUMBER,
            P.POST_TITLE,
            P.POST_CREATED_DATE,
            P.POST_VIEW_COUNT,
            I.INQUIRY_STATUS
            FROM TBL_MEMBER M 
            JOIN TBL_POST P ON M.MEMBER_NUMBER = P.MEMBER_NUMBER
            JOIN TBL_INQUIRY I ON P.POST_NUMBER = I.POST_NUMBER
            WHERE LOWER(P.POST_TITLE) LIKE '%' || LOWER(#{query}) || '%'
            OR LOWER(M.MEMBER_ID) LIKE '%' || LOWER(#{query}) || '%'
            ORDER BY P.POST_CREATED_DATE DESC
  		    ) SUBQUERY
    		)
			]]>
	</select>

</mapper>