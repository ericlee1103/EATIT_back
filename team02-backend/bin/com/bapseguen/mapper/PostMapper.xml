<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="post">
  
	<!-- 자유게시판 -->
	<!-- 자유게시판 전체 목록 조회  -->
	<select id="freeSelectAll" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
		<![CDATA[
		  SELECT * FROM (
		    SELECT ROWNUM AS RNUM, SUBQ.* FROM (
		      SELECT 
		          P.POST_NUMBER AS postNumber,
		          P.POST_TITLE AS postTitle,
		          P.POST_CREATED_DATE AS postCreatedDate,
		          P.POST_VIEW_COUNT AS postViewCount,
		          P.POST_LIKE_COUNT AS postLikeCount,
		          P.POST_TYPE AS postType,
		          P.MEMBER_NUMBER AS memberNumber,
		          M.MEMBER_ID AS memberId
		      FROM TBL_POST P
		      JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
		      WHERE P.POST_TYPE = 'FREE' AND P.POST_DELETE_STATE = 'N'
		      ORDER BY P.POST_CREATED_DATE DESC
		    ) SUBQ
		  )
		  WHERE RNUM BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
		
	<!-- 자유게시판 글 총 개수 -->
	<select id="freeGetTotal" resultType="int">
		SELECT COUNT(post_type)
		FROM TBL_POST
		WHERE post_type = 'FREE'
	</select>
	
	<!-- 자유게시판 게시글 작성 -->
	<insert id="insertFreePost" parameterType="map" useGeneratedKeys="true" keyProperty="postNumber">
	    INSERT INTO TBL_POST (
	        POST_NUMBER, MEMBER_NUMBER, POST_TITLE,
	        POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
	        POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE
	    )
	    VALUES (
	        SEQ_POST_NUMBER.NEXTVAL,
	        #{memberNumber},
	        #{postTitle},
	        0,0,0,
	        'N', SYSDATE, 'FREE'
	    )
	    <selectKey keyProperty="postNumber" resultType="int" order="AFTER">
	        SELECT SEQ_POST_NUMBER.CURRVAL FROM DUAL
	    </selectKey>
	</insert>
	<insert id="insertFreeContent" parameterType="map">
	    INSERT INTO TBL_FREE_BOARD (POST_NUMBER, FREE_CONTENT)
	    VALUES (SEQ_POST_NUMBER.CURRVAL, #{freeContent})
	</insert>
	
	<!-- 자유게시판 게시글 상세조회 (1건조회) -->
	<select id="freePostSelect" parameterType="int" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
	  SELECT
	    M.MEMBER_NUMBER      AS memberNumber,
	    M.MEMBER_ID          AS memberId,
	    P.POST_NUMBER        AS postNumber,
	    P.POST_TITLE         AS postTitle,
	    P.POST_CREATED_DATE  AS postCreatedDate,
	    P.POST_VIEW_COUNT    AS postViewCount,
	    P.POST_LIKE_COUNT    AS postLikeCount,
	    P.POST_TYPE          AS postType,        
	    F.FREE_CONTENT       AS freeContent
	  FROM TBL_MEMBER M
	  JOIN TBL_POST P
	    ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	  LEFT JOIN TBL_FREE_BOARD F
	    ON F.POST_NUMBER = P.POST_NUMBER
	  WHERE P.POST_NUMBER = #{postNumber}
	</select>
	
	
	<!-- 홍보게시판 -->
	<!-- 홍보게시판 목록 조희 -->
	<select id="promoSelectAll" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
		<![CDATA[
		  SELECT * FROM (
		    SELECT ROWNUM AS RNUM, SUBQ.* FROM (
		      SELECT 
		          P.POST_NUMBER AS postNumber,
		          P.POST_TITLE AS postTitle,
		          P.POST_CREATED_DATE AS postCreatedDate,
		          P.POST_VIEW_COUNT AS postViewCount,
		          P.POST_LIKE_COUNT AS postLikeCount,
		          P.POST_TYPE AS postType,
		          P.MEMBER_NUMBER AS memberNumber,
		          M.MEMBER_ID AS memberId
		      FROM TBL_POST P
		      JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
		      WHERE P.POST_TYPE = 'PROMOTION' AND P.POST_DELETE_STATE = 'N'
		      ORDER BY P.POST_CREATED_DATE DESC
		    ) SUBQ
		  )
		  WHERE RNUM BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 홍보게시판 글 총 개수 -->
	<select id="promoGetTotal" resultType="int">
		SELECT COUNT(post_type)
		FROM TBL_POST
		WHERE post_type = 'PROMOTION'
	</select>
	
	<!-- 홍보게시판 게시글 상세조회 (1건조회) -->
	<select id="promoPostSelect" parameterType="int" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
	  SELECT
	    P.POST_NUMBER       AS postNumber,
	    P.POST_TITLE        AS postTitle,
	    P.POST_CREATED_DATE AS postCreatedDate,
	    P.POST_VIEW_COUNT   AS postViewCount,
	    P.POST_LIKE_COUNT   AS postLikeCount,
	    P.POST_TYPE         AS postType,
	    PB.PROMO_CONTENT    AS promoContent,
	    M.MEMBER_NUMBER     AS memberNumber,
	    M.MEMBER_ID         AS memberId,
	    A.ADMIN_NUMBER      AS adminNumber,
	    A.ADMIN_ID          AS adminId
	  FROM TBL_POST P
	  LEFT JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	  LEFT JOIN TBL_ADMIN  A ON P.ADMIN_NUMBER = A.ADMIN_NUMBER
	  LEFT JOIN TBL_PROMO_BOARD PB ON PB.POST_NUMBER = P.POST_NUMBER
	  WHERE P.POST_NUMBER = #{postNumber}
	</select>
	
	<!-- 홍보게시판 게시글 작성 -->
	<insert id="insertPromoPost" parameterType="map" useGeneratedKeys="true" keyProperty="postNumber">
	    INSERT INTO TBL_POST (
	        POST_NUMBER, MEMBER_NUMBER, POST_TITLE,
	        POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
	        POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE
	    )
	    VALUES (
	        SEQ_POST_NUMBER.NEXTVAL,
	        #{memberNumber},
	        #{postTitle},
	        0,0,0,
	        'N', SYSDATE, 'PROMOTION'
	    )
	    <selectKey keyProperty="postNumber" resultType="int" order="AFTER">
	        SELECT SEQ_POST_NUMBER.CURRVAL FROM DUAL
	    </selectKey>
	    
	</insert>
	
	<insert id="insertPromoContent" parameterType="map">
	    INSERT INTO TBL_PROMO_BOARD (POST_NUMBER, PROMO_CONTENT)
	    VALUES (#{postNumber}, #{promoContent})
	</insert>
	

	<!-- 레시피 게시판 -->
	<!-- 레시피게시판 목록 조희 -->
	<select id="recipeSelectAll" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
		<![CDATA[
		  SELECT * FROM (
		    SELECT ROWNUM AS RNUM, SUBQ.* FROM (
		      SELECT 
		          P.POST_NUMBER AS postNumber,
		          P.POST_TITLE AS postTitle,
		          P.POST_CREATED_DATE AS postCreatedDate,
		          P.POST_VIEW_COUNT AS postViewCount,
		          P.POST_LIKE_COUNT AS postLikeCount,
		          P.POST_TYPE AS postType,
		          P.MEMBER_NUMBER AS memberNumber,
		          M.MEMBER_ID AS memberId
		      FROM TBL_POST P
		      JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
		      WHERE P.POST_TYPE = 'RECIPE' AND P.POST_DELETE_STATE = 'N'
		      ORDER BY P.POST_CREATED_DATE DESC
		    ) SUBQ
		  )
		  WHERE RNUM BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	<!-- 레시피게시판 글 총 개수 -->
	<select id="recipeGetTotal" resultType="int">
		SELECT COUNT(post_type)
		FROM TBL_POST
		WHERE post_type = 'RECIPE'
	</select>
	
	<!-- 레시피게시판 게시글 상세조회 (1건조회) -->
	<select id="recipePostSelect" parameterType="int" resultType="com.bapseguen.app.dto.view.PostDetailDTO">
	  SELECT
	    P.POST_NUMBER       AS postNumber,
	    P.POST_TITLE        AS postTitle,
	    P.POST_CREATED_DATE AS postCreatedDate,
	    P.POST_VIEW_COUNT   AS postViewCount,
	    P.POST_LIKE_COUNT   AS postLikeCount,
	    P.POST_TYPE         AS postType,
	    PB.RECIPE_CONTENT    AS recipeContent,
	    M.MEMBER_NUMBER     AS memberNumber,
	    M.MEMBER_ID         AS memberId,
	    A.ADMIN_NUMBER      AS adminNumber,
	    A.ADMIN_ID          AS adminId
	  FROM TBL_POST P
	  LEFT JOIN TBL_MEMBER M ON P.MEMBER_NUMBER = M.MEMBER_NUMBER
	  LEFT JOIN TBL_ADMIN  A ON P.ADMIN_NUMBER = A.ADMIN_NUMBER
	  LEFT JOIN TBL_RECIPE_BOARD PB ON PB.POST_NUMBER = P.POST_NUMBER
	  WHERE P.POST_NUMBER = #{postNumber}
	</select>
	
	<!-- 레시피게시판 게시글 작성 -->
	<insert id="insertRecipePost" parameterType="map" useGeneratedKeys="true" keyProperty="postNumber">
	    INSERT INTO TBL_POST (
	        POST_NUMBER, MEMBER_NUMBER, POST_TITLE,
	        POST_LIKE_COUNT, POST_VIEW_COUNT, POST_REPORT_COUNT,
	        POST_DELETE_STATE, POST_CREATED_DATE, POST_TYPE
	    )
	    VALUES (
	        SEQ_POST_NUMBER.NEXTVAL,
	        #{memberNumber},
	        #{postTitle},
	        0,0,0,
	        'N', SYSDATE, 'RECIPE'
	    )
	    <selectKey keyProperty="postNumber" resultType="int" order="AFTER">
	        SELECT SEQ_POST_NUMBER.CURRVAL FROM DUAL
	    </selectKey>
	</insert>
	
	<insert id="insertRecipeContent" parameterType="map">
	    INSERT INTO TBL_RECIPE_BOARD (POST_NUMBER, RECIPE_CONTENT)
	    VALUES (#{postNumber}, #{recipeContent})
	</insert>
	
	<!--조회수 쿼리  -->
	<update id="postUpdateReadCount" parameterType="int">
		UPDATE TBL_POST
		SET POST_VIEW_COUNT=POST_VIEW_COUNT+1
		WHERE POST_NUMBER=#{postNumber}
	</update>
	<!-- 현재 조회수 쿼리 -->
	<select id="getViewCount" parameterType="int" resultType="int">
	    SELECT POST_VIEW_COUNT
	    FROM TBL_POST 
	    WHERE POST_NUMBER=#{postNumber}
	</select>
	
	<!-- 자유게시판 게시글 삭제 쿼리 / 글 내용-->	
	<delete id="freeBoardDelete" parameterType="int">
	    DELETE FROM TBL_FREE_BOARD
	    WHERE POST_NUMBER = #{postNumber}
	</delete>
	<!-- 홍보게시판 게시글 삭제 쿼리 / 글 내용-->	
	<delete id="promoBoardDelete" parameterType="int">
	    DELETE FROM TBL_PROMO_BOARD
	    WHERE POST_NUMBER = #{postNumber}
	</delete>
	<!-- 레시피게시판 게시글 삭제 쿼리 / 글 내용-->	
	<delete id="recipeBoardDelete" parameterType="int">
	    DELETE FROM TBL_RECIPE_BOARD
	    WHERE POST_NUMBER = #{postNumber}
	</delete>
	
	
	<!--  게시글 삭제 쿼리 / 게시글 내용제외-->
	<delete id="postDelete" parameterType="int">
	    DELETE FROM TBL_POST
	    WHERE POST_NUMBER = #{postNumber}
	</delete>
	<!-- 게시판 게시글 삭제 쿼리 / 이미지-->
	<delete id="postImageDelete" parameterType="int">
	    DELETE FROM TBL_POST_IMAGE
	    WHERE POST_NUMBER = #{postNumber}
	</delete>
	
	
	<!-- 게시글 삭제시 포스트타입 조회 -->
	<select id="getPostType" parameterType="int" resultType="string">
	    SELECT POST_TYPE
	    FROM TBL_POST
	    WHERE POST_NUMBER = #{postNumber}
	</select>



	<!-- 게시글 수정쿼리/제목,날짜 -->
	<update id="updatePostTitle" parameterType="PostDetailDTO">
	    UPDATE TBL_POST
	    SET 
	        POST_TITLE = #{postTitle},
	        POST_UPDATED_DATE = SYSDATE
	    WHERE POST_NUMBER = #{postNumber}
	</update>
	<!-- 자유게시판 게시글 수정쿼리 / 내용 -->
	<update id="updateFreeContent" parameterType="PostDetailDTO">
	    UPDATE TBL_FREE_BOARD
	    SET 
	        FREE_CONTENT = #{freeContent}
	    WHERE POST_NUMBER = #{postNumber}
	</update>
	<!-- 홍보게시판 게시글 수정쿼리 / 내용 -->
	<update id="updatePromoContent" parameterType="PostDetailDTO">
	    UPDATE TBL_PROMO_BOARD
	    SET 
	        PROMO_CONTENT = #{promoContent}
	    WHERE POST_NUMBER = #{postNumber}
	</update>
	<!-- 레시피게시판 게시글 수정쿼리 / 내용 -->
	<update id="updateRecipeContent" parameterType="PostDetailDTO">
	    UPDATE TBL_RECIPE_BOARD
	    SET 
	        RECIPE_CONTENT = #{recipeContent}
	    WHERE POST_NUMBER = #{postNumber}
	</update>
		
		
	<!-- 추천수 이미 추천했는지 확인 -->
	<select id="checkLike" parameterType="map" resultType="int">
	    SELECT 1 
	    FROM TBL_LIKE 
	    WHERE POST_NUMBER=#{postNumber} AND MEMBER_NUMBER=#{memberNumber}
	</select>
	
	<!-- 작성자 조회 -->
	<select id="getAuthorNumber" parameterType="int" resultType="int">
	    SELECT 
	        CASE 
	            WHEN MEMBER_NUMBER IS NOT NULL THEN MEMBER_NUMBER
	            ELSE ADMIN_NUMBER
	        END AS AUTHOR_NUMBER
	    FROM TBL_POST
	    WHERE POST_NUMBER = #{postNumber}
	</select>
	
	<!-- 추천 중복 체크 -->
	<select id="hasLiked" parameterType="map" resultType="int">
	    SELECT COUNT(*)
	    FROM TBL_LIKE
	    WHERE POST_NUMBER = #{postNumber} AND MEMBER_NUMBER = #{memberNumber}
	</select>
	
	<!-- 추천 추가 + 게시글 추천수 증가 -->
	<update id="insertLikeAndUpdateCount" parameterType="map">
	  BEGIN
	    INSERT INTO TBL_LIKE (POST_NUMBER, MEMBER_NUMBER)
	    VALUES (#{postNumber}, #{memberNumber});
	    
	    UPDATE TBL_POST
	    SET POST_LIKE_COUNT = POST_LIKE_COUNT + 1
	    WHERE POST_NUMBER = #{postNumber};
	  END;
	</update>
	
	<!-- 추천수 조회 -->
	<select id="getLikeCount" parameterType="int" resultType="int">
	    SELECT POST_LIKE_COUNT
	    FROM TBL_POST
	    WHERE POST_NUMBER=#{postNumber}
	</select>
	
	
	
	<!-- 내가 작성한 게시글 조회 -->
	<select id="myPostSelect" resultType="PostDetailDTO">
		<![CDATA[
		SELECT * FROM (
		  SELECT ROWNUM AS RNUM, SUBQUERY.*
	    FROM (
	      SELECT 
	      p.POST_NUMBER, 
	      p.POST_TYPE,	     
	      p.POST_TITLE,
	      p.POST_CREATED_DATE AS postCreatedDate,
	      p.POST_VIEW_COUNT AS postViewCount,
	      p.POST_LIKE_COUNT AS postLikeCount,
	      p.POST_DELETE_STATE AS deleteState,
	          (SELECT count(c.COMMENT_NUMBER) FROM TBL_COMMENT c WHERE c.POST_NUMBER = p.POST_NUMBER  ) AS commentCount
	      FROM TBL_POST p 
	      WHERE p.MEMBER_NUMBER = #{memberNumber}
	        AND p.POST_DELETE_STATE = 'N'
	      ORDER BY p.POST_CREATED_DATE DESC
	    ) SUBQUERY
	  )WHERE RNUM BETWEEN #{startRow} AND #{endRow}
		]]>
	</select>
	
	<!-- 내가 작성한 게시글 개수 조회 -->
	<select id="myPostCount" resultType="int">
		<![CDATA[
		SELECT count(*) FROM (
		  SELECT ROWNUM AS RNUM, SUBQUERY.*
		    FROM (
		      SELECT p.POST_NUMBER, p.POST_TITLE,p.POST_TYPE,p.POST_CREATED_DATE,p.POST_VIEW_COUNT,p.POST_LIKE_COUNT, p.POST_DELETE_STATE,
		          (SELECT count(c.COMMENT_NUMBER) FROM TBL_COMMENT c WHERE c.POST_NUMBER = p.POST_NUMBER  ) AS comment_count
		      FROM TBL_POST p 
		      WHERE p.MEMBER_NUMBER = #{memberNumber}
		        AND p.POST_DELETE_STATE = 'N'
		      ORDER BY p.POST_CREATED_DATE DESC
		    ) SUBQUERY
		  )
		]]>
	</select>
	
	<update id="postUpdateTitle" parameterType="PostDTO">
  		UPDATE TBL_POST
    	SET POST_TITLE = #{postTitle}, POST_UPDATED_DATE = SYSDATE
   		WHERE POST_NUMBER = #{postNumber}
	</update>
	
	<!-- <update id="freeUpdateContent" parameterType="FreeBoardDTO">
  		UPDATE TBL_FREE_BOARD
     	SET FREE_CONTENT = #{freeContent}
   		WHERE POST_NUMBER = #{postNumber}
	</update> -->
	
</mapper>