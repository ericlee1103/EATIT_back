<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="myReview">

	<!--내가 작성한 리뷰 조회  -->
	<select id="myReviewSelect" resultType="ReviewWriteDTO">
	<![CDATA[
	 SELECT * FROM (
    SELECT ROWNUM AS RNUM, SUBQUERY.*
    FROM (
		  SELECT 
			  (SELECT S.STORE_NAME FROM tbl_store s WHERE s.BUSINESS_NUMBER = r.BUSINESS_NUMBER )AS storeName,
				(SELECT CASE I.ITEM_TYPE
			                WHEN 'FOOD' THEN '음식'
			                WHEN 'INGREDIENT' THEN '재료'
			                ELSE I.ITEM_TYPE
			            END 
			    FROM TBL_ITEM I  WHERE I.ITEM_NUMBER = OI.ITEM_NUMBER) AS itemType,		    
			    (SELECT I.ITEM_NAME FROM TBL_ITEM I  WHERE I.ITEM_NUMBER = OI.ITEM_NUMBER) AS itemName,
			    R.REVIEW_CONTENT AS reviewContent,
			    OI.ORDER_ITEM_QUANTITY AS orderItemQuantity,
			    OI.ORDER_ITEM_UNIT_PRICE AS orderItemUnitPrice,
			    R.REVIEW_RATING AS reviewRating,
			    TO_CHAR(R.REVIEW_CREATE_DATE, 'YYYY-MM-DD') AS reviewCreateDate
			FROM TBL_REVIEW R
			INNER JOIN TBL_ORDER_ITEM OI ON r.ORDERS_NUMBER = OI.ORDERS_NUMBER
			WHERE R.MEMBER_NUMBER = #{memberNumber}
		) SUBQUERY
  )WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!--내가 작성한 리뷰 총 개수 조회  -->
	<select id="myReviewCount" resultType="int">
	<![CDATA[
	 SELECT count(*) FROM (
    SELECT ROWNUM AS RNUM, SUBQUERY.*
    FROM (
      SELECT REVIEW_NUMBER,ORDERS_NUMBER,BUSINESS_NUMBER,MEMBER_NUMBER,REVIEW_RATING,REVIEW_CONTENT,REVIEW_CREATE_DATE
      FROM TBL_REVIEW
      WHERE MEMBER_NUMBER = #{memberNumber}
      ORDER BY REVIEW_CREATE_DATE DESC
    ) SUBQUERY
  )WHERE RNUM BETWEEN #{startRow} AND #{endRow}
	]]>
	</select>
	
	<!-- 내가 구매한 상품 리뷰 작성 -->
	<insert id="myReviewInsert" parameterType="ReviewWriteDTO">
	  INSERT INTO TBL_REVIEW (REVIEW_NUMBER,ORDERS_NUMBER,BUSINESS_NUMBER,MEMBER_NUMBER,REVIEW_RATING,REVIEW_CONTENT,REVIEW_CREATE_DATE)
	  VALUES (
	    SEQ_REVIEW_NUMBER.NEXTVAL,#{ordersNumber},#{businessNumber},#{memberNumber},#{reviewRating},#{reviewContent},SYSDATE
	  )
	</insert>
	
	

</mapper>