<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="seller">

<!-- 마이페이지 진입전 비밀번호 확인 -->
<select id="chkPw" parameterType="SellerInfoDTO" resultType="int">
	SELECT member_number 
	FROM TBL_MEMEBER
	WHERE MEMBER_PASSWORD = #{MEMBER_PASSWORD} AND MEMBER_NUMBER = #{MEMBER_NUMBER}
</select>

<!-- 사업자번호 조회 -->
	<select id="getBusinessNumber" parameterType="int" resultType="String">
		<![CDATA[
		SELECT
		s.business_number
		FROM TBL_MEMBER m
		INNER JOIN TBL_SELLER_MEMBER sm
			ON sm.member_number = m.MEMBER_NUMBER
		INNER JOIN TBL_STORE s
			ON s.member_number = sm.MEMBER_NUMBER
		WHERE m.member_number = #{memberNumber}
		]]>
	</select>
<!-- 내 정보 조회 -->
	<select id="selectSellerinfo" parameterType="int" resultType="SellerInfoDTO">
	<![CDATA[
	SELECT
	  m.member_number, m.member_id, m.member_password,
	  sm.seller_name,
	  to_char(sm.seller_birthdate,'YYYY-MM-DD'),
	  sm.seller_phone_number,
	  to_char(sm.seller_updated_date,'YYYY-MM-DD'),
	  s.business_number, s.store_name,
	  to_char(s.store_open_date,'YYYY-MM-DD'),      
	  s.store_tel, s.store_address, s.store_address_detail, s.store_zip_code,
	  s.store_open_time, s.store_close_time
	FROM TBL_MEMBER m
	INNER JOIN TBL_SELLER_MEMBER sm
		ON sm.member_number = m.MEMBER_NUMBER
	INNER JOIN TBL_STORE s
		ON s.member_number = sm.MEMBER_NUMBER
	WHERE m.member_number = #{memberNumber}
	]]>
	</select>
	

	<!-- =========== 리뷰 작성 ========== -->	
  <!-- 리뷰 저장 -->
  <insert id="insertReview" parameterType="com.bapseguen.app.dto.ReviewDTO">
    <selectKey keyProperty="reviewNumber" 
    
    
    resultType="int" order="BEFORE">
      SELECT SEQ_REVIEW_NUMBER.NEXTVAL FROM DUAL
    </selectKey>
    INSERT INTO TBL_REVIEW(
      REVIEW_NUMBER, MEMBER_NUMBER, ORDERS_NUMBER, BUSINESS_NUMBER, ITEM_NUMBER,
      REVIEW_RATING, REVIEW_CONTENT, REVIEW_CREATE_DATE
    ) VALUES (
      #{reviewNumber}, #{memberNumber}, #{ordersNumber}, #{businessNumber}, #{itemNumber},
      #{reviewRating}, #{reviewContent}, SYSDATE
    )
  </insert>
  
    <!-- 이미 리뷰 존재 여부 -->
  <select id="existsReview" parameterType="map" resultType="int">
    SELECT COUNT(*)
    FROM TBL_REVIEW
    WHERE ORDERS_NUMBER = #{ordersNumber}
      AND ITEM_NUMBER   = #{itemNumber}
      AND MEMBER_NUMBER = #{memberNumber}
  </select>

	<!-- 리뷰 작성 여부 확인 -->
</mapper>